<!DOCTYPE html>
<html>
	<head>
		{% load static %}
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
		<script src='{% static "spectrum/spectrum.js" %}'></script>
		<link rel='stylesheet' href='{% static "spectrum/spectrum.css" %}' />
	</head>
	<body>
	
		<p>Hello World</p>
		<canvas id="whiteboard"></canvas>
		<input type='text' id="color-picker" />
		<p id="debug"></p>
	</body>
</html>
<style>

	canvas {
		width: 500px;
		height: 250px;
		background: #eeeeee;
		border: 1px solid black;
	}

</style>
<script>

$(document).ready(function(){
	
	var ctx = document.getElementById("whiteboard").getContext('2d');
	var prevX = null, prevY = null, mouseDown = false;
	var path = [], color = '#000000', width = 5;
	
	$("#color-picker").spectrum({
		color: color,
		change: function(newColor){
			color = newColor.toHexString();
			$("#debug").text(newColor.toHexString());
		}
	});
	
	$('#whiteboard')
		.mousedown(function(e){
		mouseDown = true;
		draw(e.pageX - $(this).offset().left, e.pageY - $(this).offset().top, false);
	})
		.mousemove(function(e){
//		$("#debug").text($("#custom").value());
		if(mouseDown)
			draw(e.pageX - $(this).offset().left, e.pageY - $(this).offset().top, true);
	})
		.mouseup(function(e){
		mouseDown = false;
		$("#debug").text(JSON.stringify(getPathJSON()));
	})
		.mouseleave(function(e){
		mouseDown = false;
		$("#debug").text(JSON.stringify(getPathJSON()));
	});
	
	function draw(x, y, mouseDown){
		x = Math.floor(x * 3 / 5); // magic numbers idk why they work i hate it
		y = Math.floor(y * 3 / 5);
		if(mouseDown && (x != prevX || y != prevY)){
			ctx.beginPath();
			ctx.strokeStyle = color;
			ctx.lineWidth = width;
			ctx.lineJoin = 'round';
			ctx.moveTo(prevX, prevY);
			ctx.lineTo(x, y);
			ctx.closePath();
			ctx.stroke();
			path.push(x + ':' + y);
		}
		prevX = x;
		prevY = y;
	}
	
	function getPathJSON(){
		if(path.length == 0) return null;
		var json = {
			color: color,
			width: width,
			path: path
		};
		path = [];
		return json;
	}
	
});
	
</script>